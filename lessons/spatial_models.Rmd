---
title: "Spatial Models"
output: html_document
---

The goals of this lesson are to introduce how spatial dependence is tested 
for and how it can be corrected for or explained in uni- and multi-variate 
modeling frameworks. 

## Readings

* The R Book p778-785 on Generalized Least Squares models with spatially
correlated errors
* Numerical Ecology in R, p228-238 on detecting spatial dependence.

## Outline

* Spatial autocorrelation and induced spatial dependence
* Detecting a spatial signal
* Univariate modeling
* Multivariate modeling

## Spatial autocorrelation and induced spatial dependence

There are two general reasons why spatial dependence may 
exist in a response variable.

1) autocorrelation - the variable is simply inherently aggregated due its own
internal dynamics. In ecology this is sometimes referred to as a false gradient

2) induced spatial dependence: the variable is inherently spatially structured 
but the driving factors that it responses to are. In ecology this is sometimes
referred to as a true gradient

There is no statistical way to distinguish false from true gradients.

## Detecting a spatial signal

```{r}
library(vegan)
library(nlme)
# Oribatid mite data. 70 soil cores collected by Daniel Borcard in 1989.
# See Borcard et al. (1992, 1994) for details.
data(mite)
data(mite.env)
data(mite.xy)

head(mite)
head(mite.env)
head(mite.xy)
```
```{r}
plot(mite.xy)

sr = apply(mite, 1, function(x) sum(x > 0))
hist(sr)

plot(mite.xy, cex=sr/max(sr))

col_brks = hist(sr, plot=F)$breaks
col_indices = as.numeric(cut(sr, col_brks))
cols = rev(terrain.colors(length(col_brks)))
plot(mite.xy, cex=2, pch=19, col=cols[col_indices])
```

Visually it appears that low richness sites (i.e., brown circles) are more 
likely to be near other low richness sites - this indicates a pattern of 
spatial dependence. We can carry out some very simple analyses to
examine if this relationship is stronger than we would expect under a 
null model of randomly shuffled spatial positions. Our test statistic in this 
context is the Pearson correlation coefficient between the difference in the
response variable (i.e., richness) and the difference in spatial proximity. 

```{r}
# calculate Euclidean distance between richness and spatial coordinates
sr_dist = dist(sr)
xy_dist = dist(mite.xy)

# plot result
plot(xy_dist, sr_dist)
abline(lm(sr_dist ~ xy_dist), lwd=3, col='red')
lines(lowess(xy_dist, sr_dist), lwd=3, col='pink')

# compute correlation
obs_cor = cor(xy_dist, sr_dist)
obs_cor

# carry out a permutation test for significance:
nperm = 1000
null_cor = obs_cor
for (i in 2:nperm) {
    # shuffle the rows of the spatial coordinates
    tmp_xy = mite.xy[sample(nrow(mite.xy)), ]
    # correlation between the shuffled spatial coordinates and sr_dist
    null_cor[i] = cor(dist(tmp_xy), sr_dist)
}
# compute the p-value
sum(null_cor >= obs_cor) / nperm 

# carry out the same analysis using the function mantel()
sr_mantel = mantel(xy_dist, sr_dist)
sr_mantel

# compare the two approaches graphically using stacked boxplots
boxplot(list(null_cor, sr_mantel$perm), horizontal = T, boxwex = 0.5,
        names = c('mine', 'theirs'), xlab='Correlation')
abline(v=obs_cor, col='red')

# as expected they look almost identical and the observed value is 
# much larger than then null realizations indicating that there is a 
# signficant difference between the observed spatial pattern and one due to
# random chance.
```

This preliminary analysis suggests that there is a significant relationship 
between the spatial distance that two points are separated and the difference
in species richness of the points. We can undertake a similar approach to 
examining a multivariate response variable such as species composition

```{r}
## compute bray curtis distance for the community matrix
comm_dist = vegdist(mite)
plot(xy_dist, comm_dist)
abline(lm(comm_dist ~ xy_dist), lwd=3, col='red')
lines(lowess(xy_dist, comm_dist), lwd=3, col='pink')
comm_mantel = mantel(xy_dist, comm_dist)
comm_mantel
```

The previous plots included both the linear regression model which is what the 
mantel analysis is based upon and the lowess smoother line. The smoother can
help to identify if the relationship is non-linear and how the strength of the 
relationship varies with spatial distance. 

```{r}
sr_corlog = mantel.correlog(sr_dist, xy_dist)
comm_corlog = mantel.correlog(comm_dist, xy_dist)
sr_corlog
comm_corlog

par(mfrow=c(1,2))
plot(sr_corlog)
mtext(side=3, 'Species Richness')
plot(comm_corlog)
mtext(side=3, 'Community Composition')
```


## Univariate Modeling 
Spatial (and temporal) dependence is a potential problem for inferential
statistics because of an assumption of independence of error. However, if 
sufficient data is available it is often possible to model the spatial 
component of error and thus "correct" for the lack of independence in a model's
error. 

```{r}
sr_dat = data.frame(sr, mite.env, mite.xy)

sr_lm = gls(sr ~ SubsDens, data=sr_dat)

par(mfrow=c(1,1))
plot(Variogram(sr_lm, form= ~ x + y))
res = residuals(sr_lm)
plot(dist(sr_dat[, c('x', 'y')]), dist(res))
lines(lowess(dist(sr_dat[, c('x', 'y')]), dist(res)), col='red', lwd=2)

sr_exp = update(sr_lm, corr=corExp(1, form=~x + y))
plot(Variogram(sr_exp, resType='n'))

sr_spher = update(sr_lm, corr=corSpher(c(6, .2), form=~x + y, nugget=T))
plot(Variogram(sr_spher, resType='n'))

sr_lin = update(sr_lm, corr=corLin(form=~x+y, nugget=F))
plot(Variogram(sr_spher, resType='n'))

AIC(sr_lm)
AIC(sr_exp)
AIC(sr_spher)
AIC(sr_lin)

summary(sr_spher)
```

Examine spatial dependence in multivariate response such as species
composition in a modeling framework

```{r}
mite_rda = rda(mite, mite.env[ , 1:2])

plot(mite_rda)
anova(mite_rda)

mite_mso_raw = mso(rda(mite), mite.xy, permutations = 1000)
mite_mso = mso(mite_rda, mite.xy, permutations = 1000)
mite_mso
par(mfrow=c(1,1))
msoplot(mite_mso_raw)
msoplot(mite_mso)
```





